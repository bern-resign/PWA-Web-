<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Tugas PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6"> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0/dist/tf.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
        }
        #message-box {
            display: none;
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background-color: #1f2937;
            color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
        }
        .task-item {
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-8 bg-gray-100">

    <div class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl max-w-lg w-full text-center border border-gray-100">
        <div class="flex items-center justify-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">Daftar Tugas</h1>
        </div>
        <p class="text-gray-500 mb-8 text-lg">Kelola semua tugas Anda secara offline dan efisien.</p>
        
        <div class="flex flex-col md:flex-row gap-3 mb-8">
            <input type="text" id="task-input" class="flex-1 p-4 rounded-xl border-2 border-gray-200 focus:outline-none focus:ring-4 focus:ring-blue-200 transition-all duration-300" placeholder="Tambahkan tugas baru...">
            <button id="add-task-btn" class="bg-blue-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                Tambah Tugas
            </button>
        </div>

        <div id="status-container" class="mb-8 p-4 rounded-xl font-semibold text-center border-2">
            </div>

        <ul id="task-list" class="space-y-4 text-left">
            </ul>
        
    </div>

    <div id="message-box" class="transition-opacity duration-300">
        Pesan telah ditampilkan!
    </div>

    <script>
        const taskInput = document.getElementById('task-input');
        const addTaskBtn = document.getElementById('add-task-btn');
        const taskList = document.getElementById('task-list');
        const statusContainer = document.getElementById('status-container');
        
        // --- Bagian ML: Model dan Tokenizer yang lebih canggih ---
        let model;
        const categories = ['Kerja', 'Pribadi', 'Belanja', 'Lain-lain'];
        const maxSequenceLength = 10;
        
        // Objek vocabulary yang lebih luas, mensimulasikan tokenizer nyata
        const vocabulary = {
            'pad': 0, 'rapat': 1, 'proyek': 2, 'laporan': 3, 'email': 4, 'kerja': 5, 'bulan': 6,
            'beli': 7, 'belanja': 8, 'supermarket': 9, 'bayar': 10, 'tagihan': 11,
            'olahraga': 12, 'gym': 13, 'lari': 14, 'teman': 15, 'dokter': 16, 'keluarga': 17,
            'siapkan': 18, 'kumpul': 19, 'tulis': 20, 'persiapan': 21
        };

        // Fungsi untuk memuat model. Dalam produksi, ini akan memuat file model.
        async function loadModel() {
            // Simulasi loading model yang canggih dengan arsitektur LSTM
            try {
                // Di sini, kita akan memuat model dari URL, misalnya:
                // model = await tf.loadLayersModel('URL_MODEL_ANDA/model.json');
                
                // Untuk demo, kita buat model sederhana yang mensimulasikan arsitektur LSTM
                const model_internal = tf.sequential();
                model_internal.add(tf.layers.embedding({
                    inputDim: Object.keys(vocabulary).length, 
                    outputDim: 16, 
                    inputLength: maxSequenceLength
                }));
                model_internal.add(tf.layers.lstm({units: 32}));
                model_internal.add(tf.layers.dense({units: categories.length, activation: 'softmax'}));
                model_internal.compile({optimizer: 'adam', loss: 'categoricalCrossentropy'});
                
                // Memberikan berat acak untuk demo
                // Di produksi, bobot ini akan diisi dari file yang dilatih
                await model_internal.save('localstorage://my-model');
                model = await tf.loadLayersModel('localstorage://my-model');
                
                console.log('Model klasifikasi berbasis LSTM berhasil dimuat.');
            } catch (error) {
                console.error('Gagal memuat atau membuat model:', error);
            }
        }
        
        // Fungsi untuk tokenisasi dan padding yang lebih cerdas
        function tokenizeAndPad(text) {
            const words = text.toLowerCase().split(/\s+/);
            const sequence = words.map(word => vocabulary[word] || 0); // Tokenisasi
            
            // Padding
            const paddedSequence = Array(maxSequenceLength).fill(0);
            const start = Math.max(0, sequence.length - maxSequenceLength);
            for (let i = 0; i < Math.min(sequence.length, maxSequenceLength); i++) {
                paddedSequence[i] = sequence[start + i];
            }
            return paddedSequence;
        }

        // Fungsi untuk memprediksi kategori menggunakan model yang canggih
        async function predictCategory(text) {
            if (!model) {
                return 'Lain-lain';
            }
            
            const tokenized = tokenizeAndPad(text);
            const inputTensor = tf.tensor2d([tokenized], [1, maxSequenceLength]);
            
            const prediction = model.predict(inputTensor);
            const predictedCategoryIndex = prediction.argMax(-1).dataSync()[0];
            
            // Cleanup tensor
            inputTensor.dispose();
            prediction.dispose();
            
            return categories[predictedCategoryIndex];
        }

        // Fungsi pembantu untuk mendapatkan warna badge kategori
        function getCategoryColor(category) {
            switch(category) {
                case 'Kerja': return 'bg-blue-100 text-blue-700';
                case 'Belanja': return 'bg-green-100 text-green-700';
                case 'Pribadi': return 'bg-yellow-100 text-yellow-700';
                default: return 'bg-gray-200 text-gray-800';
            }
        }
        
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        function updateStatus() {
            if (navigator.onLine) {
                statusContainer.textContent = 'Anda sedang online.';
                statusContainer.className = 'mb-8 p-4 rounded-xl font-semibold text-center border-2 border-green-500 bg-green-50 text-green-700';
            } else {
                statusContainer.textContent = 'Anda sedang offline.';
                statusContainer.className = 'mb-8 p-4 rounded-xl font-semibold text-center border-2 border-red-500 bg-red-50 text-red-700';
            }
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        function renderTasks() {
            taskList.innerHTML = '';
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'task-item flex flex-col items-start bg-white p-5 rounded-xl shadow-md transition-all duration-300 border border-gray-100 hover:shadow-lg';

                const headerContent = document.createElement('div');
                headerContent.className = 'flex items-center justify-between w-full mb-2';

                const taskContent = document.createElement('span');
                taskContent.textContent = task.text;
                taskContent.className = `flex-1 text-lg font-medium cursor-pointer ${task.completed ? 'line-through text-gray-400' : 'text-gray-800'}`;
                
                taskContent.addEventListener('click', () => {
                    tasks[index].completed = !tasks[index].completed;
                    if (tasks[index].completed) {
                        tasks[index].completedAt = new Date().toISOString();
                    } else {
                        tasks[index].completedAt = null;
                    }
                    saveTasks();
                    renderTasks();
                });

                const actions = document.createElement('div');
                actions.className = 'flex items-center space-x-2';

                const categoryBadge = document.createElement('span');
                categoryBadge.textContent = task.category;
                categoryBadge.className = 'text-xs font-semibold px-2 py-1 rounded-full mr-2 ' + getCategoryColor(task.category);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400 hover:text-red-600 transition-colors duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                `;
                deleteBtn.title = 'Hapus Tugas';
                deleteBtn.addEventListener('click', () => {
                    tasks.splice(index, 1);
                    saveTasks();
                    renderTasks();
                });
                
                headerContent.appendChild(taskContent);
                headerContent.appendChild(categoryBadge);
                actions.appendChild(deleteBtn);
                headerContent.appendChild(actions);

                const timeHistory = document.createElement('div');
                timeHistory.className = 'text-xs text-gray-400 mt-2';
                
                let timeText = `Ditambahkan: ${formatDate(task.createdAt)}`;
                if (task.completed && task.completedAt) {
                    timeText += ` | Selesai: ${formatDate(task.completedAt)}`;
                }
                timeHistory.textContent = timeText;

                li.appendChild(headerContent);
                li.appendChild(timeHistory);
                taskList.appendChild(li);
            });
        }

        async function addTask() {
            const taskText = taskInput.value.trim();
            if (taskText) {
                // Panggil fungsi prediksi yang lebih canggih
                const category = await predictCategory(taskText);
                tasks.push({ 
                    text: taskText, 
                    completed: false, 
                    createdAt: new Date().toISOString(), 
                    completedAt: null,
                    category: category
                });
                saveTasks();
                renderTasks();
                taskInput.value = '';
            }
        }

        addTaskBtn.addEventListener('click', addTask);
        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        window.addEventListener('load', async () => {
            updateStatus();
            await loadModel(); // Muat model saat halaman dimuat
            renderTasks();
        });
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const serviceWorkerScript = `
                    const CACHE_NAME = 'pwa-todo-cache-v1';
                    const urlsToCache = [
                        '/',
                        '/index.html',
                        'https://cdn.tailwindcss.com',
                        'https://fonts.googleapis.com',
                        'https://fonts.gstatic.com',
                        'https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap'
                    ];

                    self.addEventListener('install', event => {
                        console.log('Service Worker: Installing...');
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => {
                                    console.log('Service Worker: Caching assets');
                                    return cache.addAll(urlsToCache).catch(err => {
                                        console.error('Failed to cache:', err);
                                    });
                                })
                        );
                    });

                    self.addEventListener('activate', event => {
                        console.log('Service Worker: Activating...');
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            console.log('Service Worker: Deleting old cache', cacheName);
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                        self.clients.claim();
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    if (response) {
                                        console.log('Service Worker: Serving from cache', event.request.url);
                                        return response;
                                    }
                                    console.log('Service Worker: Fetching from network', event.request.url);
                                    return fetch(event.request);
                                })
                        );
                    });
                `;
                const blob = new Blob([serviceWorkerScript], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(swUrl)
                        .then(registration => {
                            console.log('Service Worker terdaftar dengan cakupan:', registration.scope);
                        })
                        .catch(error => {
                            console.error('Pendaftaran Service Worker gagal:', error);
                        });
                });
            }
        }
        
        const manifestData = {
          "name": "PWA To-Do List",
          "short_name": "To-Do PWA",
          "start_url": ".",
          "display": "standalone",
          "background_color": "#3b82f6",
          "theme_color": "#3b82f6",
          "icons": [
            {
              "src": "https://placehold.co/192x192/3b82f6/ffffff?text=TD",
              "sizes": "192x192",
              "type": "image/png"
            },
            {
              "src": "https://placehold.co/512x512/3b82f6/ffffff?text=TD",
              "sizes": "512x512",
              "type": "image/png"
            }
          ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);

        document.querySelector('link[rel="manifest"]').href = manifestUrl;
        
    </script>
</body>
</html>
